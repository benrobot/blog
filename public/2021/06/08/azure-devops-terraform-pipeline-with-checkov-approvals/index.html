<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Azure DevOps Terraform Pipeline with Checkov & Approvals | MediaGlasses</title>
<meta name=keywords content="Terraform,Azure Devops,Azure,Checkov,Pipeline">
<meta name=description content="It’s been just over a year since I first posted about the Azure DevOps Terraform Pipeline I used to use, I say used to use, because that pipeline is now a little outdated. This posts covers the updated Pipeline I am starting to deploy along side my Terraform code.
Pipeline Overview The pipeline itself has expanded a little and it now not only uses stages but also depending what Terraform is planning on doing it will trigger a manual approval process should there be any resources being destroyed.">
<meta name=author content="Russ Mckendrick">
<link rel=canonical href=https://www.mediaglasses.blog/2021/06/08/azure-devops-terraform-pipeline-with-checkov-approvals/>
<meta name=google-site-verification content="XYZabc">
<meta name=yandex-verification content="XYZabc">
<meta name=msvalidate.01 content="XYZabc">
<link crossorigin=anonymous href=/assets/css/stylesheet.min.1cabe33df594e7ba6ebd15554fa20e096c6fc15bd43c296f14557b489b7e95bf.css integrity="sha256-HKvjPfWU57puvRVVT6IOCWxvwVvUPClvFFV7SJt+lb8=" rel="preload stylesheet" as=style>
<link rel=preload href=/favicon.ico as=image>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.mediaglasses.blog/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://www.mediaglasses.blog/favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=https://www.mediaglasses.blog/favicon.ico>
<link rel=apple-touch-icon href=https://www.mediaglasses.blog/favicon.ico>
<link rel=mask-icon href=https://www.mediaglasses.blog/images/logo.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.87.0">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-123-45','auto'),ga('send','pageview'))</script><meta property="og:title" content="Azure DevOps Terraform Pipeline  with Checkov & Approvals">
<meta property="og:description" content="It’s been just over a year since I first posted about the Azure DevOps Terraform Pipeline I used to use, I say used to use, because that pipeline is now a little outdated. This posts covers the updated Pipeline I am starting to deploy along side my Terraform code.
Pipeline Overview The pipeline itself has expanded a little and it now not only uses stages but also depending what Terraform is planning on doing it will trigger a manual approval process should there be any resources being destroyed.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://www.mediaglasses.blog/2021/06/08/azure-devops-terraform-pipeline-with-checkov-approvals/">
<meta property="og:image" content="https://www.mediaglasses.blog/2021/06/08/azure-devops-terraform-pipeline-with-checkov-approvals/2021-06-08-azure-devops-terraform-pipeline-with-checkov-approvals.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-06-08T00:00:00+00:00">
<meta property="article:modified_time" content="2021-06-08T00:00:00+00:00"><meta property="og:site_name" content="MediaGlasses">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://www.mediaglasses.blog/2021/06/08/azure-devops-terraform-pipeline-with-checkov-approvals/2021-06-08-azure-devops-terraform-pipeline-with-checkov-approvals.png">
<meta name=twitter:title content="Azure DevOps Terraform Pipeline  with Checkov & Approvals">
<meta name=twitter:description content="It’s been just over a year since I first posted about the Azure DevOps Terraform Pipeline I used to use, I say used to use, because that pipeline is now a little outdated. This posts covers the updated Pipeline I am starting to deploy along side my Terraform code.
Pipeline Overview The pipeline itself has expanded a little and it now not only uses stages but also depending what Terraform is planning on doing it will trigger a manual approval process should there be any resources being destroyed.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.mediaglasses.blog/posts/"},{"@type":"ListItem","position":2,"name":"Azure DevOps Terraform Pipeline  with Checkov \u0026 Approvals","item":"https://www.mediaglasses.blog/2021/06/08/azure-devops-terraform-pipeline-with-checkov-approvals/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Azure DevOps Terraform Pipeline  with Checkov \u0026 Approvals","name":"Azure DevOps Terraform Pipeline  with Checkov \u0026 Approvals","description":"It’s been just over a year since I first posted about the Azure DevOps Terraform Pipeline I used to use, I say used to use, because that pipeline is now a little outdated. This posts covers the updated Pipeline I am starting to deploy along side my Terraform code.\nPipeline Overview The pipeline itself has expanded a little and it now not only uses stages but also depending what Terraform is planning on doing it will trigger a manual approval process should there be any resources being destroyed.","keywords":["Terraform","Azure Devops","Azure","Checkov","Pipeline"],"articleBody":"It’s been just over a year since I first posted about the Azure DevOps Terraform Pipeline I used to use, I say used to use, because that pipeline is now a little outdated. This posts covers the updated Pipeline I am starting to deploy along side my Terraform code.\nPipeline Overview The pipeline itself has expanded a little and it now not only uses stages but also depending what Terraform is planning on doing it will trigger a manual approval process should there be any resources being destroyed.\nThe stages in the pipeline are as follows;\n Checkov Scan, this stage run Checkov, a tool by BridgeCrew which scans Terraform configuration to find common misconfigurations before they’re deployed. The results of the scan are uploaded to the Pipeline run and are available as a report. Terraform Validate, this stage run the terraform validate command to check that the Terraform files are valid, if there are any problems the pipeline errors. Terraform Plan, this stage runs the terraform plan command. Depending in the state of resources it finds variables are set which are used to determine the next stage which is executed. The output of the terraform plan command is also upload to Azure DevOps. Terraform Apply (Auto Approval), if the Terraform Plan stage determines that the only changes to the state are additions then this stage is ran, it performs the terraform apply and effects the change. Terraform Apply (Manual Approval), if the Terraform Plan stage determines that the changes to the state includes any resources being destroyed then this stage is ran, it triggers a manual approval task prompting someone to check before the terraform apply command is executed.  The Whole workflow can be found below (click on it for a larger view);\nAs well as the addition of the stages detailed above, the pipeline has moved to using the Terraform Azure DevOps extension from Microsoft DevLabs to the Terraform Azure DevOps extension by Charles Zipp.\nThe reasoning for this is that the extension by Charles Zipp enables a lot of the functionality I needed to enable the two different approval stages without having to code the logic myself — which I am always a fan of 😉\nThe Stages Now that we have an idea of what should happen, let’s take a look at what the pipeline looks like.\nStage: Checkov Scan The first stage to run downloads and executes a scan of the Terraform files using Checkov, you will notice the YAML below that we are pulling the Checkov container from Dockerhub and the running it;\n- stage: \"runCheckov\" displayName: \"Checkov - Scan Terraform files\" jobs: - job: \"runCheckov\" displayName: \"Checkov  Pull, run and publish results of Checkov scan\" steps: - bash: | docker pull bridgecrew/checkov workingDirectory: $(System.DefaultWorkingDirectory) displayName: \"Pull  bridgecrew/checkov\" - bash: |docker run \\ --volume $(pwd):/tf bridgecrew/checkov \\ --directory /tf \\ --output junitxml \\ --soft-fail  $(pwd)/CheckovReport.xml workingDirectory: $(System.DefaultWorkingDirectory) displayName: \"Run  checkov\" - task: PublishTestResults@2 inputs: testRunTitle: \"Checkov Results\" failTaskOnFailedTests: true testResultsFormat: \"JUnit\" testResultsFiles: \"CheckovReport.xml\" searchFolder: \"$(System.DefaultWorkingDirectory)\" displayName: \"Publish  Checkov scan results\" The command to run a Checkov scan locally on your own machine using Docker is below, just make sure you run it within same folder as your Terraform code;\ndockerrun \\ --volume $(pwd):/tf \\ bridgecrew/checkov \\ --directory /tf \\ --output junitxml \\ --soft-fail \\  $(pwd)/CheckovReport.xml As you can see we are mounting the current folder (the $(pwd) variable) which as we have set the workingDirectory to be where the code has been checked out using the$(System.DefaultWorkingDirectory) variable. We are also setting the --output to be junitxml and then piping the output to a file called CheckovReport.xml.\nThe reason for using the --soft-fail flag is that if we didn’t and Checkov was to find any problems the container would exit with a status which would cause the stage to fail with this task. Instead, we want to fail the task should there be any errors in the report once we have published the results of the scan.\nWe are publishing the test results using the built in PublishTestResult task, with the failTaskOnFailedTests option set as true.\nWe will set what happens when, or if, this stage fails later in the post.\nStage: Terraform Validate This stage run the terraform validate command, and if there are any problems it will fail. As you can see the from YAML below, the stage dependsOn the runCheckov stage and we are also installing Terraform and running terraform init before the terraform validate command is executed;\n- stage: \"validateTerraform\" displayName: \"Terraform - Validate\" dependsOn: - \"runCheckov\" jobs: - job: \"TerraformJobs\" displayName: \"Terraform  install, init and validate\" continueOnError: false steps: - task: TerraformInstaller@0 inputs: terraformVersion: \"$(tf_version)\" displayName: \"Install  terraform\" - task: TerraformCLI@0 inputs: command: \"init\" backendType: \"azurerm\" backendServiceArm: \"$(SUBSCRIPTION_NAME)\" ensureBackend: true backendAzureRmResourceGroupName: \"$(tf_environment)-$(tf_state_rg)\" backendAzureRmResourceGroupLocation: \"$(tz_state_location)\" backendAzureRmStorageAccountName: \"$(tf_state_sa_name)\" backendAzureRmStorageAccountSku: \"$(tf_state_sku)\" backendAzureRmContainerName: $(tf_state_container_name) backendAzureRmKey: \"$(tf_environment).terraform.tstate\" displayName: \"Run  terraform init\" - task: TerraformCLI@0 inputs: command: \"validate\" environmentServiceName: \"$(SUBSCRIPTION_NAME)\" displayName: \"Run  terraform validate\" One of the other things which will happen when this stage is executed happens as part of the terraform init task, as we are setting ensureBackend to true the task will check for the presence of the Azure Storage Account we wish to use to store our Terraform state file in, if it is not there then the task will helpfully create it for us.\nOnce your code has been validated we can move onto the next stage.\nStage: Terraform Plan This stage is where things get a little more interesting, eventually, as our environment does not persist across stages we need to install Terraform and run terraform init again.\nOnce that has been done we are running the terraform plan command, thanks to some of the features in the Terraform Azure DevOps extension by Charles Zipp we are able to publish the results of running terraform plan to our pipeline run by setting the publishPlanResults option.\nBefore we look at the last tasks of this stage lets look at the code for the full stage;\n- stage: \"planTerraform\" displayName: \"Terraform - Plan\" dependsOn: - \"validateTerraform\" jobs: - job: \"TerraformJobs\" displayName: \"Terraform  install, init \u0026 plan\" steps: - task: TerraformInstaller@0 inputs: terraformVersion: \"$(tf_version)\" displayName: \"Install  terraform\" - task: TerraformCLI@0 inputs: command: \"init\" backendType: \"azurerm\" backendServiceArm: \"$(SUBSCRIPTION_NAME)\" ensureBackend: true backendAzureRmResourceGroupName: \"$(tf_environment)-$(tf_state_rg)\" backendAzureRmResourceGroupLocation: \"$(tz_state_location)\" backendAzureRmStorageAccountName: \"$(tf_state_sa_name)\" backendAzureRmStorageAccountSku: \"$(tf_state_sku)\" backendAzureRmContainerName: $(tf_state_container_name) backendAzureRmKey: \"$(tf_environment).terraform.tstate\" displayName: \"Run  terraform init\" - task: TerraformCLI@0 inputs: command: \"plan\" environmentServiceName: \"$(SUBSCRIPTION_NAME)\" publishPlanResults: \"PlanResults\" commandOptions: \"-out=$(System.DefaultWorkingDirectory)/terraform.tfplan -detailed-exitcode\" name: \"plan\" displayName: \"Run  terraform plan\" - task: TerraformCLI@0 inputs: command: \"show\" environmentServiceName: \"$(SUBSCRIPTION_NAME)\" inputTargetPlanOrStateFilePath: \"$(System.DefaultWorkingDirectory)/terraform.tfplan\" displayName: \"Run  terraform show\" - bash: |if [ \"$TERRAFORM_PLAN_HAS_CHANGES\" = true ] \u0026\u0026 [ \"$TERRAFORM_PLAN_HAS_DESTROY_CHANGES\" = false ] ; then echo \"##vso[task.setvariable variable=HAS_CHANGES_ONLY;isOutput=true]true\" echo \"##vso[task.logissue type=warning]Changes with no destroys detected, it is safe for the pipeline to proceed automatically\" fi if [ \"$TERRAFORM_PLAN_HAS_CHANGES\" = true ] \u0026\u0026 [ \"$TERRAFORM_PLAN_HAS_DESTROY_CHANGES\" = true ] ; then echo \"##vso[task.setvariable variable=HAS_DESTROY_CHANGES;isOutput=true]true\" echo \"##vso[task.logissue type=warning]Changes with Destroy detected, pipeline will require a manual approval to proceed\" fi if [ \"$TERRAFORM_PLAN_HAS_CHANGES\" != true ] ; then echo \"##vso[task.logissue type=warning]No changes detected, terraform apply will not run\" fi name: \"setvar\" displayName: \"Vars  Set Variables for next stage\" As you can see, after we have ran terraform plan we are immediately running terraform show using the terraform.tfplan file we just generated.\nYou maybe think to yourself, why do that? Well, when using the Terraform Azure DevOps extension by Charles Zipp it actually sets a few really useful variables. To start with, if there are any changes as a result of the terraform plan command a variable called TERRAFORM_PLAN_HAS_CHANGES is set as true.\nWhen the terraform show command is executed against a .tfplan a second variable namedTERRAFORM_PLAN_HAS_DESTROY_CHANGES will be set as true if the .tfplan contains any resources which are being destroyed.\nIn the final task of the stage we are using bash to set some variables which will help decide which, if any, of the following stages will be executed.\nSo if …\n TERRAFORM_PLAN_HAS_CHANGES = true TERRAFORM_PLAN_HAS_DESTROY_CHANGES = false  … then it is safe to proceed automatically execute the next stage, so we can pick this up in the next stages we are setting a variable named HAS_CHANGES_ONLY to true.\nBut, if we get …\n TERRAFORM_PLAN_HAS_CHANGES = true TERRAFORM_PLAN_HAS_DESTROY_CHANGES = true  … then we should prompt someone to check that what is going to be destroyed is expected, so by setting a variable called HAS_DESTROY_CHANGES to true.\nFinally, if …\n TERRAFORM_PLAN_HAS_CHANGES is not true  … then we are just printing a message which will be displayed within the pipeline run to say that no changes were detected.\nStage: Terraform Apply (Auto Approval) As you may have already guessed, this stage is only executed if the following condition is met;\ncondition: | and ( succeeded(), eq(dependencies.planTerraform.outputs['TerraformJobs.setvar.HAS_CHANGES_ONLY'], 'true') ) As you can see, we are referencing the variable which was set in the previous stage using the following echo command;\necho \"##vso[task.setvariable variable=HAS_CHANGES_ONLY;isOutput=true]true\" The variable is then referenced by adding the names of the stage, job, task and the variable itself, so something like;\ndependencies.STAGE_NAME.outputs['JOB_NAME.TASK_NAME.VARIABLE_NAME'] The full stage looks like the following;\n- stage: \"autoTerraform\" displayName: \"Terraform - Auto Approval\" dependsOn: - \"planTerraform\" condition: |and ( succeeded(), eq(dependencies.planTerraform.outputs['TerraformJobs.setvar.HAS_CHANGES_ONLY'], 'true') ) jobs: - job: \"TerraformAuto\" displayName: \"Terraform  install, init \u0026 apply\" steps: - task: TerraformInstaller@0 inputs: terraformVersion: \"$(tf_version)\" displayName: \"Install  terraform\" - task: TerraformCLI@0 inputs: command: \"init\" backendType: \"azurerm\" backendServiceArm: \"$(SUBSCRIPTION_NAME)\" ensureBackend: true backendAzureRmResourceGroupName: \"$(tf_environment)-$(tf_state_rg)\" backendAzureRmResourceGroupLocation: \"$(tz_state_location)\" backendAzureRmStorageAccountName: \"$(tf_state_sa_name)\" backendAzureRmStorageAccountSku: \"$(tf_state_sku)\" backendAzureRmContainerName: $(tf_state_container_name) backendAzureRmKey: \"$(tf_environment).terraform.tstate\" displayName: \"Run  terraform init\" - task: TerraformCLI@0 inputs: command: \"apply\" environmentServiceName: \"$(SUBSCRIPTION_NAME)\" displayName: \"Run  terraform apply\" As you can see, we are again installing Terraform and running terraform init before finally running terraform apply.\nStage: Terraform Apply (Manual Approval) This stage is almost exactly the same as the Auto Approval apart from the inclusion of a job which runs before the Terraform job;\n- stage: \"approveTerraform\" displayName: \"Terraform - Manual Approval\" dependsOn: - \"planTerraform\" condition: |and ( succeeded(), eq(dependencies.planTerraform.outputs['TerraformJobs.setvar.HAS_DESTROY_CHANGES'], 'true') ) jobs: - job: \"waitForValidation\" displayName: \"Wait  Wait for manual appoval\" pool: \"server\" timeoutInMinutes: \"4320\" # job times out in 3 days steps: - task: ManualValidation@0 timeoutInMinutes: \"1440\" # task times out in 1 day inputs: notifyUsers: | azure@mckendrick.io instructions: \"There are resources being destroyed as part of this deployment, please review the output of Terraform plan before approving.\" onTimeout: \"reject\" - job: \"TerraformApprove\" displayName: \"Terraform  install, init \u0026 apply\" dependsOn: \"waitForValidation\" steps: - task: TerraformInstaller@0 inputs: terraformVersion: \"$(tf_version)\" displayName: \"Install  terraform\" - task: TerraformCLI@0 inputs: command: \"init\" backendType: \"azurerm\" backendServiceArm: \"$(SUBSCRIPTION_NAME)\" ensureBackend: true backendAzureRmResourceGroupName: \"$(tf_environment)-$(tf_state_rg)\" backendAzureRmResourceGroupLocation: \"$(tz_state_location)\" backendAzureRmStorageAccountName: \"$(tf_state_sa_name)\" backendAzureRmStorageAccountSku: \"$(tf_state_sku)\" backendAzureRmContainerName: $(tf_state_container_name) backendAzureRmKey: \"$(tf_environment).terraform.tstate\" displayName: \"Run  terraform init\" - task: TerraformCLI@0 inputs: command: \"apply\" environmentServiceName: \"$(SUBSCRIPTION_NAME)\" displayName: \"Run  terraform apply\" This job basically stalls the pipeline execution for 24 hours, after which, if no-one approves the run, the job will fail. The job utilises the ManualValidation@0 task, more detail on which can be found at https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/utility/manual-validation.\nOnce approved the Terraform job will be executed which will ultimately run terraform apply which will result in at least one of the resources in your Terraform state file being destroyed.\nRunning the Pipeline Let’t now take a look at running the pipeline, first let’s check in some code which adds a basic Resource Group.\nThe Terraform code for this looks like the following;\nresource \"azurecaf_name\" \"rg_example\" { name = \"demogroup\" resource_type = \"azurerm_resource_group\" prefixes = [\"dev\"] clean_input = true } resource \"azurerm_resource_group\" \"resource_group\" { name = azurecaf_name.rg_example.result location = \"uksouth\" tags = merge(var.default_tags, tomap({ \"type\" = \"resource\" })) } I am using the Azure CAF Name provider to generate the name of the resource group and then the AzureRM provider to create it.\nInitial Run As you can from the screen below, there was a single error, which stated that the storage account for the Terraform state file did not exist, buts that OK as that will be created for us.\nThe two screens below show the warnings;\n \nNo ChangesRun The next run didn’t add, change or remove any resources which meant that neither the HAS_CHANGES_ONLY or HAS_DESTROY_CHANGES variables were set to true, so the terraform apply stages did not run this time;\nIntroducing some mistakes One thing which hasn’t happened yet is that we have not added anything which Checkov would scan, let’s do that now by adding a Network Security Group to our Terraform file;\nresource \"azurecaf_name\" \"nsg\" { name = \"demo\" resource_type = \"azurerm_network_security_group\" prefixes = [\"dev\"] clean_input = true } resource \"azurecaf_name\" \"ssh\" { name = \"ssh\" resource_type = \"azurerm_network_security_rule\" prefixes = [\"dev\"] clean_input = true } resource \"azurecaf_name\" \"rdp\" { name = \"rdp\" resource_type = \"azurerm_network_security_rule\" prefixes = [\"dev\"] clean_input = true } resource azurerm_network_security_group \"nsg\" { name = azurecaf_name.nsg.result resource_group_name = azurerm_resource_group.resource_group.name location = azurerm_resource_group.resource_group.location security_rule { access = \"Allow\" direction = \"Inbound\" name = azurecaf_name.ssh.result priority = 200 protocol = \"TCP\" source_address_prefix = \"*\" source_port_range = \"*\" destination_port_range = \"22-22\" destination_address_prefix = \"*\" } security_rule { access = \"Allow\" direction = \"Inbound\" name = azurecaf_name.rdp.result priority = 300 protocol = \"TCP\" source_address_prefix = \"*\" source_port_range = \"*\" destination_port_range = \"3389-3389\" destination_address_prefix = \"*\" } } Nothing to bad on the face of it you maybe thinking, let’s commit the change which will trigger a run of the pipeline;\nWhoops, the Checkov stage failed, clicking on Tests should give us more information as to why;\nClicking on either the two results will give a more information;\n \nAs you can see, we are allow full access to both SSH and RDP to the whole internet — not a great idea so we will need to update the code to lock those two rules down to an IP address. Thankfully, the Checkov stage errored before any of the Terraform stages were executed meaning that our mistake never made it as far as being deployed.\nA quick code change \u0026 commit later and we have the tests passing and the changes being automatically deployed — which is expected as there is only the addition of the network security group;\n \nLet’s now look at removing the network security group we just added.\nManual Approval Commenting out the network security group configuration in the Terraform code and committing it should be enough to trigger a run which will resource in resources being removed.\nThis will result in an e-mail;\nGoing to the pipeline, clicking on Review, entering a comment then pressing the Resume button will then trigger the terraform apply stage;\n \nOnce complete the network security group will have been destroyed, which is what we expected to happen, however, sometimes something unexpected may have happened and resources which you thought were not being touched by your changes maybe being destroyed so that they can be redeployed to make a change which isn’t possible any other way, this is where having your pipeline prompt you that it is going to remove resources comes in extremely useful 😊\nSummary As I find myself collaborating on more and more complex Terraform deployments it can get a little scary for all involved if you have a pipeline triggering automatically when you commit.\nThis means having checks in place which not only make sure that simple mistakes, like opening up management ports to the internet, but also to check that the code is valid before it gets executed is a good safety net.\nAn even bigger safety net is triggering the terraform apply command based on the results of a terraform plan so that checks can be made to ensure that nothing bad or unexpected is going to happen as a result of the changes you are applying —after all, stoping an outage before it becomes an outage is always the best option 👍\nYou can find the full pipeline along with the Terraform code at https://github.com/russmckendrick/DevOpsTerraformPipeline.\n","wordCount":"2631","inLanguage":"en","image":"https://www.mediaglasses.blog/2021/06/08/azure-devops-terraform-pipeline-with-checkov-approvals/2021-06-08-azure-devops-terraform-pipeline-with-checkov-approvals.png","datePublished":"2021-06-08T00:00:00Z","dateModified":"2021-06-08T00:00:00Z","author":{"@type":"Person","name":"Russ Mckendrick"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.mediaglasses.blog/2021/06/08/azure-devops-terraform-pipeline-with-checkov-approvals/"},"publisher":{"@type":"Organization","name":"MediaGlasses","logo":{"@type":"ImageObject","url":"https://www.mediaglasses.blog/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<noscript>
<style type=text/css>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://www.mediaglasses.blog/ accesskey=h title="MediaGlasses (Alt + H)">
<img src=/favicon.ico alt=logo aria-label=logo height=35>MediaGlasses</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://www.mediaglasses.blog/tags/ title=tags>
<span>tags</span>
</a>
</li>
<li>
<a href=https://russ.mckendrick.io/ title=about>
<span>about</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://www.mediaglasses.blog/>Home</a>&nbsp;»&nbsp;<a href=https://www.mediaglasses.blog/posts/>Posts</a></div>
<h1 class=post-title>
Azure DevOps Terraform Pipeline with Checkov & Approvals
</h1>
<div class=post-meta>June 8, 2021&nbsp;·&nbsp;13 min&nbsp;·&nbsp;Russ Mckendrick&nbsp;|&nbsp;<a href=https://github.com/russmckendrick/blog/tree/main/content//posts/2021-06-08-azure-devops-terraform-pipeline-with-checkov-approvals/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header>
<figure class=entry-cover>
<img loading=lazy srcset="https://www.mediaglasses.blog/2021/06/08/azure-devops-terraform-pipeline-with-checkov-approvals/_hu1c71a0046260f26b2debe35b936969fb_4815081_5203e2946c97139e3b2c9ff8fdab9cf4.png 360w ,https://www.mediaglasses.blog/2021/06/08/azure-devops-terraform-pipeline-with-checkov-approvals/_hu1c71a0046260f26b2debe35b936969fb_4815081_f9f4bf2108743e3158eea3d8e88e2ff4.png 480w ,https://www.mediaglasses.blog/2021/06/08/azure-devops-terraform-pipeline-with-checkov-approvals/_hu1c71a0046260f26b2debe35b936969fb_4815081_37e125c71c88b1319b7a520fcf8e1a0f.png 720w ,https://www.mediaglasses.blog/2021/06/08/azure-devops-terraform-pipeline-with-checkov-approvals/_hu1c71a0046260f26b2debe35b936969fb_4815081_f632ebf5ccc5691730d46f19e70d1b79.png 1080w ,https://www.mediaglasses.blog/2021/06/08/azure-devops-terraform-pipeline-with-checkov-approvals/_hu1c71a0046260f26b2debe35b936969fb_4815081_3dd87d35342b14ff6dde3356c22060a1.png 1500w ,https://www.mediaglasses.blog/2021/06/08/azure-devops-terraform-pipeline-with-checkov-approvals/2021-06-08-azure-devops-terraform-pipeline-with-checkov-approvals.png 2500w" sizes="(min-width: 768px) 720px, 100vw" src=https://www.mediaglasses.blog/2021/06/08/azure-devops-terraform-pipeline-with-checkov-approvals/2021-06-08-azure-devops-terraform-pipeline-with-checkov-approvals.png alt>
</figure>
<div class=post-content><p>It’s been just over a year since I <a href=https://mediaglasses.blog/azure-devops-terraform-pipeline-e50f1721ea1>first posted about the Azure DevOps Terraform Pipeline I used to use</a>, I say used to use, because that pipeline is now a little outdated. This posts covers the updated Pipeline I am starting to deploy along side my Terraform code.</p>
<h3 id=pipeline-overview>Pipeline Overview<a hidden class=anchor aria-hidden=true href=#pipeline-overview>#</a></h3>
<p>The pipeline itself has expanded a little and it now not only uses stages but also depending what Terraform is planning on doing it will trigger a manual approval process should there be any resources being destroyed.</p>
<p>The stages in the pipeline are as follows;</p>
<ul>
<li><strong>Checkov Scan</strong>, this stage run <a href=http://checkov.io/>Checkov</a>, a tool by <a href=https://bridgecrew.io/>BridgeCrew</a> which scans Terraform configuration to find common misconfigurations before they’re deployed. The results of the scan are uploaded to the Pipeline run and are available as a report.</li>
<li><strong>Terraform Validate</strong>, this stage run the <code>terraform validate</code> command to check that the Terraform files are valid, if there are any problems the pipeline errors.</li>
<li><strong>Terraform Plan</strong>, this stage runs the <code>terraform plan</code> command. Depending in the state of resources it finds variables are set which are used to determine the next stage which is executed. The output of the <code>terraform plan</code> command is also upload to Azure DevOps.</li>
<li><strong>Terraform Apply (Auto Approval)</strong>, if the Terraform Plan stage determines that the only changes to the state are additions then this stage is ran, it performs the <code>terraform apply</code> and effects the change.</li>
<li><strong>Terraform Apply (Manual Approval)</strong>, if the Terraform Plan stage determines that the changes to the state includes any resources being destroyed then this stage is ran, it triggers a manual approval task prompting someone to check before the <code>terraform apply</code> command is executed.</li>
</ul>
<p>The Whole workflow can be found below (click on it for a larger view);</p>
<p><img loading=lazy src=images/azure-devops-terraform-pipeline-01.svg alt>
</p>
<p>As well as the addition of the stages detailed above, the pipeline has moved to using the <a href="https://marketplace.visualstudio.com/items?itemName=ms-devlabs.custom-terraform-tasks&ssr=false#overview">Terraform Azure DevOps extension from Microsoft DevLabs</a> to the <a href="https://marketplace.visualstudio.com/items?itemName=charleszipp.azure-pipelines-tasks-terraform">Terraform Azure DevOps extension by Charles Zipp</a>.</p>
<p>The reasoning for this is that the extension by <a href=https://github.com/charleszipp/azure-pipelines-tasks-terraform>Charles Zipp</a> enables a lot of the functionality I needed to enable the two different approval stages without having to code the logic myself — which I am always a fan of 😉</p>
<h3 id=the-stages>The Stages<a hidden class=anchor aria-hidden=true href=#the-stages>#</a></h3>
<p>Now that we have an idea of what should happen, let’s take a look at what the pipeline looks like.</p>
<h4 id=stage-checkovscan>Stage: Checkov Scan<a hidden class=anchor aria-hidden=true href=#stage-checkovscan>#</a></h4>
<p>The first stage to run downloads and executes a scan of the Terraform files using <a href=http://checkov.io/>Checkov</a>, you will notice the YAML below that we are pulling the <a href=https://hub.docker.com/r/bridgecrew/checkov>Checkov container from Dockerhub</a> and the running it;</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>  - <span style=color:#f92672>stage</span>: <span style=color:#e6db74>&#34;runCheckov&#34;</span>
    <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Checkov - Scan Terraform files&#34;</span>
    <span style=color:#f92672>jobs</span>:
      - <span style=color:#f92672>job</span>: <span style=color:#e6db74>&#34;runCheckov&#34;</span>
        <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Checkov &gt; Pull, run and publish results of Checkov scan&#34;</span>
        <span style=color:#f92672>steps</span>:
          - <span style=color:#f92672>bash</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>              </span>              <span style=color:#ae81ff>docker pull bridgecrew/checkov</span>
            <span style=color:#f92672>workingDirectory</span>: <span style=color:#ae81ff>$(System.DefaultWorkingDirectory)</span>
            <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Pull &gt; bridgecrew/checkov&#34;</span>
          - <span style=color:#f92672>bash</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>              docker run \
</span><span style=color:#e6db74>                --volume $(pwd):/tf bridgecrew/checkov \
</span><span style=color:#e6db74>                --directory /tf \
</span><span style=color:#e6db74>                --output junitxml \
</span><span style=color:#e6db74>                --soft-fail &gt; $(pwd)/CheckovReport.xml</span>              
            <span style=color:#f92672>workingDirectory</span>: <span style=color:#ae81ff>$(System.DefaultWorkingDirectory)</span>
            <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Run &gt; checkov&#34;</span>
          - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>PublishTestResults@2</span>
            <span style=color:#f92672>inputs</span>:
              <span style=color:#f92672>testRunTitle</span>: <span style=color:#e6db74>&#34;Checkov Results&#34;</span>
              <span style=color:#f92672>failTaskOnFailedTests</span>: <span style=color:#66d9ef>true</span>
              <span style=color:#f92672>testResultsFormat</span>: <span style=color:#e6db74>&#34;JUnit&#34;</span>
              <span style=color:#f92672>testResultsFiles</span>: <span style=color:#e6db74>&#34;CheckovReport.xml&#34;</span>
              <span style=color:#f92672>searchFolder</span>: <span style=color:#e6db74>&#34;$(System.DefaultWorkingDirectory)&#34;</span>
            <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Publish &gt; Checkov scan results&#34;</span>
</code></pre></div><p>The command to run a Checkov scan locally on your own machine using Docker is below, just make sure you run it within same folder as your Terraform code;</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terminfo data-lang=terminfo><span style=color:#f92672>docker</span><span style=color:#a6e22e> run \
</span><span style=color:#a6e22e>    --volume $(pwd):/tf \
</span><span style=color:#a6e22e>    bridgecrew/checkov \
</span><span style=color:#a6e22e>    --directory /tf \
</span><span style=color:#a6e22e>    --output junitxml \
</span><span style=color:#a6e22e>    --soft-fail \
</span><span style=color:#a6e22e>    &gt; $(pwd)/CheckovReport.xml
</span></code></pre></div><p>As you can see we are mounting the current folder (the <code>$(pwd) </code>variable) which as we have set the <code>workingDirectory</code> to be where the code has been checked out using the<code>$(System.DefaultWorkingDirectory)</code> variable. We are also setting the <code>--output</code> to be <code>junitxml</code> and then piping the output to a file called CheckovReport.xml.</p>
<p>The reason for using the <code>--soft-fail</code> flag is that if we didn&rsquo;t and Checkov was to find any problems the container would exit with a status which would cause the stage to fail with this task. Instead, we want to fail the task should there be any errors in the report once we have published the results of the scan.</p>
<p>We are publishing the test results using the built in <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/test/publish-test-results?view=azure-devops&tabs=trx%2Cyaml">PublishTestResult</a> task, with the <code>failTaskOnFailedTests</code> option set as <code>true</code>.</p>
<p>We will set what happens when, or if, this stage fails later in the post.</p>
<h4 id=stage-terraform-validate>Stage: Terraform Validate<a hidden class=anchor aria-hidden=true href=#stage-terraform-validate>#</a></h4>
<p>This stage run the <code>terraform validate</code> command, and if there are any problems it will fail. As you can see the from YAML below, the stage dependsOn the <code>runCheckov</code> stage and we are also installing Terraform and running <code>terraform init</code> before the <code>terraform validate</code> command is executed;</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>  - <span style=color:#f92672>stage</span>: <span style=color:#e6db74>&#34;validateTerraform&#34;</span>
    <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Terraform - Validate&#34;</span>
    <span style=color:#f92672>dependsOn</span>:
      - <span style=color:#e6db74>&#34;runCheckov&#34;</span>
    <span style=color:#f92672>jobs</span>:
      - <span style=color:#f92672>job</span>: <span style=color:#e6db74>&#34;TerraformJobs&#34;</span>
        <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Terraform &gt; install, init and validate&#34;</span>
        <span style=color:#f92672>continueOnError</span>: <span style=color:#66d9ef>false</span>
        <span style=color:#f92672>steps</span>:
          - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>TerraformInstaller@0</span>
            <span style=color:#f92672>inputs</span>:
              <span style=color:#f92672>terraformVersion</span>: <span style=color:#e6db74>&#34;$(tf_version)&#34;</span>
            <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Install &gt; terraform&#34;</span>

          - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>TerraformCLI@0</span>
            <span style=color:#f92672>inputs</span>:
              <span style=color:#f92672>command</span>: <span style=color:#e6db74>&#34;init&#34;</span>
              <span style=color:#f92672>backendType</span>: <span style=color:#e6db74>&#34;azurerm&#34;</span>
              <span style=color:#f92672>backendServiceArm</span>: <span style=color:#e6db74>&#34;$(SUBSCRIPTION_NAME)&#34;</span>
              <span style=color:#f92672>ensureBackend</span>: <span style=color:#66d9ef>true</span>
              <span style=color:#f92672>backendAzureRmResourceGroupName</span>: <span style=color:#e6db74>&#34;$(tf_environment)-$(tf_state_rg)&#34;</span>
              <span style=color:#f92672>backendAzureRmResourceGroupLocation</span>: <span style=color:#e6db74>&#34;$(tz_state_location)&#34;</span>
              <span style=color:#f92672>backendAzureRmStorageAccountName</span>: <span style=color:#e6db74>&#34;$(tf_state_sa_name)&#34;</span>
              <span style=color:#f92672>backendAzureRmStorageAccountSku</span>: <span style=color:#e6db74>&#34;$(tf_state_sku)&#34;</span>
              <span style=color:#f92672>backendAzureRmContainerName</span>: <span style=color:#ae81ff>$(tf_state_container_name)</span>
              <span style=color:#f92672>backendAzureRmKey</span>: <span style=color:#e6db74>&#34;$(tf_environment).terraform.tstate&#34;</span>
            <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Run &gt; terraform init&#34;</span>

          - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>TerraformCLI@0</span>
            <span style=color:#f92672>inputs</span>:
              <span style=color:#f92672>command</span>: <span style=color:#e6db74>&#34;validate&#34;</span>
              <span style=color:#f92672>environmentServiceName</span>: <span style=color:#e6db74>&#34;$(SUBSCRIPTION_NAME)&#34;</span>
            <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Run &gt; terraform validate&#34;</span>
</code></pre></div><p>One of the other things which will happen when this stage is executed happens as part of the <code>terraform init</code> task, as we are setting <code>ensureBackend</code> to <code>true</code> the task will check for the presence of the Azure Storage Account we wish to use to store our Terraform state file in, if it is not there then the task will helpfully create it for us.</p>
<p>Once your code has been validated we can move onto the next stage.</p>
<h4 id=stage-terraform-plan><strong>Stage: Terraform Plan</strong><a hidden class=anchor aria-hidden=true href=#stage-terraform-plan>#</a></h4>
<p>This stage is where things get a little more interesting, eventually, as our environment does not persist across stages we need to install Terraform and run <code>terraform init</code> again.</p>
<p>Once that has been done we are running the <code>terraform plan</code> command, thanks to some of the features in the <a href="https://marketplace.visualstudio.com/items?itemName=charleszipp.azure-pipelines-tasks-terraform">Terraform Azure DevOps extension by Charles Zipp</a> we are able to publish the results of running<code> terraform plan</code> to our pipeline run by setting the <code>publishPlanResults</code> option.</p>
<p>Before we look at the last tasks of this stage lets look at the code for the full stage;</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>  - <span style=color:#f92672>stage</span>: <span style=color:#e6db74>&#34;planTerraform&#34;</span>
    <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Terraform - Plan&#34;</span>
    <span style=color:#f92672>dependsOn</span>:
      - <span style=color:#e6db74>&#34;validateTerraform&#34;</span>
    <span style=color:#f92672>jobs</span>:
      - <span style=color:#f92672>job</span>: <span style=color:#e6db74>&#34;TerraformJobs&#34;</span>
        <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Terraform &gt; install, init &amp; plan&#34;</span>
        <span style=color:#f92672>steps</span>:
          - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>TerraformInstaller@0</span>
            <span style=color:#f92672>inputs</span>:
              <span style=color:#f92672>terraformVersion</span>: <span style=color:#e6db74>&#34;$(tf_version)&#34;</span>
            <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Install &gt; terraform&#34;</span>

          - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>TerraformCLI@0</span>
            <span style=color:#f92672>inputs</span>:
              <span style=color:#f92672>command</span>: <span style=color:#e6db74>&#34;init&#34;</span>
              <span style=color:#f92672>backendType</span>: <span style=color:#e6db74>&#34;azurerm&#34;</span>
              <span style=color:#f92672>backendServiceArm</span>: <span style=color:#e6db74>&#34;$(SUBSCRIPTION_NAME)&#34;</span>
              <span style=color:#f92672>ensureBackend</span>: <span style=color:#66d9ef>true</span>
              <span style=color:#f92672>backendAzureRmResourceGroupName</span>: <span style=color:#e6db74>&#34;$(tf_environment)-$(tf_state_rg)&#34;</span>
              <span style=color:#f92672>backendAzureRmResourceGroupLocation</span>: <span style=color:#e6db74>&#34;$(tz_state_location)&#34;</span>
              <span style=color:#f92672>backendAzureRmStorageAccountName</span>: <span style=color:#e6db74>&#34;$(tf_state_sa_name)&#34;</span>
              <span style=color:#f92672>backendAzureRmStorageAccountSku</span>: <span style=color:#e6db74>&#34;$(tf_state_sku)&#34;</span>
              <span style=color:#f92672>backendAzureRmContainerName</span>: <span style=color:#ae81ff>$(tf_state_container_name)</span>
              <span style=color:#f92672>backendAzureRmKey</span>: <span style=color:#e6db74>&#34;$(tf_environment).terraform.tstate&#34;</span>
            <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Run &gt; terraform init&#34;</span>

          - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>TerraformCLI@0</span>
            <span style=color:#f92672>inputs</span>:
              <span style=color:#f92672>command</span>: <span style=color:#e6db74>&#34;plan&#34;</span>
              <span style=color:#f92672>environmentServiceName</span>: <span style=color:#e6db74>&#34;$(SUBSCRIPTION_NAME)&#34;</span>
              <span style=color:#f92672>publishPlanResults</span>: <span style=color:#e6db74>&#34;PlanResults&#34;</span>
              <span style=color:#f92672>commandOptions</span>: <span style=color:#e6db74>&#34;-out=$(System.DefaultWorkingDirectory)/terraform.tfplan -detailed-exitcode&#34;</span>
            <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;plan&#34;</span>
            <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Run &gt; terraform plan&#34;</span>

          - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>TerraformCLI@0</span>
            <span style=color:#f92672>inputs</span>:
              <span style=color:#f92672>command</span>: <span style=color:#e6db74>&#34;show&#34;</span>
              <span style=color:#f92672>environmentServiceName</span>: <span style=color:#e6db74>&#34;$(SUBSCRIPTION_NAME)&#34;</span>
              <span style=color:#f92672>inputTargetPlanOrStateFilePath</span>: <span style=color:#e6db74>&#34;$(System.DefaultWorkingDirectory)/terraform.tfplan&#34;</span>
            <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Run &gt; terraform show&#34;</span>

          - <span style=color:#f92672>bash</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>              if [ &#34;$TERRAFORM_PLAN_HAS_CHANGES&#34; = true ] &amp;&amp; [ &#34;$TERRAFORM_PLAN_HAS_DESTROY_CHANGES&#34; = false ] ; then
</span><span style=color:#e6db74>                echo &#34;##vso[task.setvariable variable=HAS_CHANGES_ONLY;isOutput=true]true&#34;
</span><span style=color:#e6db74>                echo &#34;##vso[task.logissue type=warning]Changes with no destroys detected, it is safe for the pipeline to proceed automatically&#34;
</span><span style=color:#e6db74>                fi
</span><span style=color:#e6db74>              if [ &#34;$TERRAFORM_PLAN_HAS_CHANGES&#34; = true ] &amp;&amp; [ &#34;$TERRAFORM_PLAN_HAS_DESTROY_CHANGES&#34; = true ] ; then
</span><span style=color:#e6db74>                echo &#34;##vso[task.setvariable variable=HAS_DESTROY_CHANGES;isOutput=true]true&#34;
</span><span style=color:#e6db74>                echo &#34;##vso[task.logissue type=warning]Changes with Destroy detected, pipeline will require a manual approval to proceed&#34;
</span><span style=color:#e6db74>                fi
</span><span style=color:#e6db74>              if [ &#34;$TERRAFORM_PLAN_HAS_CHANGES&#34; != true ] ; then
</span><span style=color:#e6db74>                echo &#34;##vso[task.logissue type=warning]No changes detected, terraform apply will not run&#34;
</span><span style=color:#e6db74>              fi</span>              
            <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;setvar&#34;</span>
            <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Vars &gt; Set Variables for next stage&#34;</span>
</code></pre></div><p>As you can see, after we have ran <code>terraform plan</code> we are immediately running <code>terraform show</code> using the <code>terraform.tfplan</code> file we just generated.</p>
<p>You maybe think to yourself, why do that? Well, when using the <a href="https://marketplace.visualstudio.com/items?itemName=charleszipp.azure-pipelines-tasks-terraform">Terraform Azure DevOps extension by Charles Zipp</a> it actually sets a few really useful variables. To start with, if there are any changes as a result of the <code>terraform plan</code> command a variable called <code>TERRAFORM_PLAN_HAS_CHANGES</code> is set as <code>true</code>.</p>
<p>When the <code>terraform show</code> command is executed against a <code>.tfplan</code> a second variable named<code>TERRAFORM_PLAN_HAS_DESTROY_CHANGES</code> will be set as <code>true</code> if the <code>.tfplan</code> contains any resources which are being destroyed.</p>
<p>In the final task of the stage we are using bash to set some variables which will help decide which, if any, of the following stages will be executed.</p>
<p>So if …</p>
<ul>
<li><code>TERRAFORM_PLAN_HAS_CHANGES</code> = <code>true</code></li>
<li><code>TERRAFORM_PLAN_HAS_DESTROY_CHANGES</code> = <code>false</code></li>
</ul>
<p>… then it is safe to proceed automatically execute the next stage, so we can pick this up in the next stages we are setting a variable named <code>HAS_CHANGES_ONLY</code> to <code>true</code>.</p>
<p>But, if we get …</p>
<ul>
<li><code>TERRAFORM_PLAN_HAS_CHANGES</code> = <code>true</code></li>
<li><code>TERRAFORM_PLAN_HAS_DESTROY_CHANGES</code> = <code>true</code></li>
</ul>
<p>… then we should prompt someone to check that what is going to be destroyed is expected, so by setting a variable called <code>HAS_DESTROY_CHANGES</code> to <code>true</code>.</p>
<p>Finally, if …</p>
<ul>
<li><code>TERRAFORM_PLAN_HAS_CHANGES</code> is not <code>true</code></li>
</ul>
<p>… then we are just printing a message which will be displayed within the pipeline run to say that no changes were detected.</p>
<h4 id=stage-terraform-apply-auto-approval>Stage: Terraform Apply (Auto Approval)<a hidden class=anchor aria-hidden=true href=#stage-terraform-apply-auto-approval>#</a></h4>
<p>As you may have already guessed, this stage is only executed if the following condition is met;</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>condition</span>: <span style=color:#ae81ff>|</span>
<span style=color:#ae81ff>and</span>
<span style=color:#ae81ff>(</span>
<span style=color:#ae81ff>succeeded(),</span>
<span style=color:#ae81ff>eq(dependencies.planTerraform.outputs[&#39;TerraformJobs.setvar.HAS_CHANGES_ONLY&#39;], &#39;true&#39;)</span>
<span style=color:#ae81ff>)</span>
</code></pre></div><p>As you can see, we are referencing the variable which was set in the previous stage using the following <code>echo</code> command;</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>echo <span style=color:#e6db74>&#34;##vso[task.setvariable variable=HAS_CHANGES_ONLY;isOutput=true]true&#34;</span>
</code></pre></div><p>The variable is then referenced by adding the names of the stage, job, task and the variable itself, so something like;</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ae81ff>dependencies.STAGE_NAME.outputs[&#39;JOB_NAME.TASK_NAME.VARIABLE_NAME&#39;]</span>
</code></pre></div><p>The full stage looks like the following;</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>  - <span style=color:#f92672>stage</span>: <span style=color:#e6db74>&#34;autoTerraform&#34;</span>
    <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Terraform - Auto Approval&#34;</span>
    <span style=color:#f92672>dependsOn</span>:
      - <span style=color:#e6db74>&#34;planTerraform&#34;</span>
    <span style=color:#f92672>condition</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>      and
</span><span style=color:#e6db74>        (
</span><span style=color:#e6db74>          succeeded(),
</span><span style=color:#e6db74>          eq(dependencies.planTerraform.outputs[&#39;TerraformJobs.setvar.HAS_CHANGES_ONLY&#39;], &#39;true&#39;)
</span><span style=color:#e6db74>        )</span>      
    <span style=color:#f92672>jobs</span>:
      - <span style=color:#f92672>job</span>: <span style=color:#e6db74>&#34;TerraformAuto&#34;</span>
        <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Terraform &gt; install, init &amp; apply&#34;</span>
        <span style=color:#f92672>steps</span>:
          - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>TerraformInstaller@0</span>
            <span style=color:#f92672>inputs</span>:
              <span style=color:#f92672>terraformVersion</span>: <span style=color:#e6db74>&#34;$(tf_version)&#34;</span>
            <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Install &gt; terraform&#34;</span>

          - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>TerraformCLI@0</span>
            <span style=color:#f92672>inputs</span>:
              <span style=color:#f92672>command</span>: <span style=color:#e6db74>&#34;init&#34;</span>
              <span style=color:#f92672>backendType</span>: <span style=color:#e6db74>&#34;azurerm&#34;</span>
              <span style=color:#f92672>backendServiceArm</span>: <span style=color:#e6db74>&#34;$(SUBSCRIPTION_NAME)&#34;</span>
              <span style=color:#f92672>ensureBackend</span>: <span style=color:#66d9ef>true</span>
              <span style=color:#f92672>backendAzureRmResourceGroupName</span>: <span style=color:#e6db74>&#34;$(tf_environment)-$(tf_state_rg)&#34;</span>
              <span style=color:#f92672>backendAzureRmResourceGroupLocation</span>: <span style=color:#e6db74>&#34;$(tz_state_location)&#34;</span>
              <span style=color:#f92672>backendAzureRmStorageAccountName</span>: <span style=color:#e6db74>&#34;$(tf_state_sa_name)&#34;</span>
              <span style=color:#f92672>backendAzureRmStorageAccountSku</span>: <span style=color:#e6db74>&#34;$(tf_state_sku)&#34;</span>
              <span style=color:#f92672>backendAzureRmContainerName</span>: <span style=color:#ae81ff>$(tf_state_container_name)</span>
              <span style=color:#f92672>backendAzureRmKey</span>: <span style=color:#e6db74>&#34;$(tf_environment).terraform.tstate&#34;</span>
            <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Run &gt; terraform init&#34;</span>

          - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>TerraformCLI@0</span>
            <span style=color:#f92672>inputs</span>:
              <span style=color:#f92672>command</span>: <span style=color:#e6db74>&#34;apply&#34;</span>
              <span style=color:#f92672>environmentServiceName</span>: <span style=color:#e6db74>&#34;$(SUBSCRIPTION_NAME)&#34;</span>
            <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Run &gt; terraform apply&#34;</span>
</code></pre></div><p>As you can see, we are again installing Terraform and running <code>terraform init</code> before finally running <code>terraform apply</code>.</p>
<h4 id=stage-terraform-apply-manual-approval>Stage: Terraform Apply (Manual Approval)<a hidden class=anchor aria-hidden=true href=#stage-terraform-apply-manual-approval>#</a></h4>
<p>This stage is almost exactly the same as the Auto Approval apart from the inclusion of a job which runs before the Terraform job;</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>  - <span style=color:#f92672>stage</span>: <span style=color:#e6db74>&#34;approveTerraform&#34;</span>
    <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Terraform - Manual Approval&#34;</span>
    <span style=color:#f92672>dependsOn</span>:
      - <span style=color:#e6db74>&#34;planTerraform&#34;</span>
    <span style=color:#f92672>condition</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>      and
</span><span style=color:#e6db74>        (
</span><span style=color:#e6db74>          succeeded(),
</span><span style=color:#e6db74>          eq(dependencies.planTerraform.outputs[&#39;TerraformJobs.setvar.HAS_DESTROY_CHANGES&#39;], &#39;true&#39;)
</span><span style=color:#e6db74>        )</span>      
    <span style=color:#f92672>jobs</span>:
      - <span style=color:#f92672>job</span>: <span style=color:#e6db74>&#34;waitForValidation&#34;</span>
        <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Wait &gt; Wait for manual appoval&#34;</span>
        <span style=color:#f92672>pool</span>: <span style=color:#e6db74>&#34;server&#34;</span>
        <span style=color:#f92672>timeoutInMinutes</span>: <span style=color:#e6db74>&#34;4320&#34;</span> <span style=color:#75715e># job times out in 3 days</span>
        <span style=color:#f92672>steps</span>:
          - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>ManualValidation@0</span>
            <span style=color:#f92672>timeoutInMinutes</span>: <span style=color:#e6db74>&#34;1440&#34;</span> <span style=color:#75715e># task times out in 1 day</span>
            <span style=color:#f92672>inputs</span>:
              <span style=color:#f92672>notifyUsers</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>                </span>                <span style=color:#ae81ff>azure@mckendrick.io</span>
              <span style=color:#f92672>instructions</span>: <span style=color:#e6db74>&#34;There are resources being destroyed as part of this deployment, please review the output of Terraform plan before approving.&#34;</span>
              <span style=color:#f92672>onTimeout</span>: <span style=color:#e6db74>&#34;reject&#34;</span>

      - <span style=color:#f92672>job</span>: <span style=color:#e6db74>&#34;TerraformApprove&#34;</span>
        <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Terraform &gt; install, init &amp; apply&#34;</span>
        <span style=color:#f92672>dependsOn</span>: <span style=color:#e6db74>&#34;waitForValidation&#34;</span>
        <span style=color:#f92672>steps</span>:
          - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>TerraformInstaller@0</span>
            <span style=color:#f92672>inputs</span>:
              <span style=color:#f92672>terraformVersion</span>: <span style=color:#e6db74>&#34;$(tf_version)&#34;</span>
            <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Install &gt; terraform&#34;</span>

          - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>TerraformCLI@0</span>
            <span style=color:#f92672>inputs</span>:
              <span style=color:#f92672>command</span>: <span style=color:#e6db74>&#34;init&#34;</span>
              <span style=color:#f92672>backendType</span>: <span style=color:#e6db74>&#34;azurerm&#34;</span>
              <span style=color:#f92672>backendServiceArm</span>: <span style=color:#e6db74>&#34;$(SUBSCRIPTION_NAME)&#34;</span>
              <span style=color:#f92672>ensureBackend</span>: <span style=color:#66d9ef>true</span>
              <span style=color:#f92672>backendAzureRmResourceGroupName</span>: <span style=color:#e6db74>&#34;$(tf_environment)-$(tf_state_rg)&#34;</span>
              <span style=color:#f92672>backendAzureRmResourceGroupLocation</span>: <span style=color:#e6db74>&#34;$(tz_state_location)&#34;</span>
              <span style=color:#f92672>backendAzureRmStorageAccountName</span>: <span style=color:#e6db74>&#34;$(tf_state_sa_name)&#34;</span>
              <span style=color:#f92672>backendAzureRmStorageAccountSku</span>: <span style=color:#e6db74>&#34;$(tf_state_sku)&#34;</span>
              <span style=color:#f92672>backendAzureRmContainerName</span>: <span style=color:#ae81ff>$(tf_state_container_name)</span>
              <span style=color:#f92672>backendAzureRmKey</span>: <span style=color:#e6db74>&#34;$(tf_environment).terraform.tstate&#34;</span>
            <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Run &gt; terraform init&#34;</span>

          - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>TerraformCLI@0</span>
            <span style=color:#f92672>inputs</span>:
              <span style=color:#f92672>command</span>: <span style=color:#e6db74>&#34;apply&#34;</span>
              <span style=color:#f92672>environmentServiceName</span>: <span style=color:#e6db74>&#34;$(SUBSCRIPTION_NAME)&#34;</span>
            <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Run &gt; terraform apply&#34;</span>
</code></pre></div><p>This job basically stalls the pipeline execution for 24 hours, after which, if no-one approves the run, the job will fail. The job utilises the <code>ManualValidation@0</code> task, more detail on which can be found at <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/utility/manual-validation?view=azure-devops&tabs=yaml">https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/utility/manual-validation</a>.</p>
<p>Once approved the Terraform job will be executed which will ultimately run <code>terraform apply</code> which will result in at least one of the resources in your Terraform state file being destroyed.</p>
<h3 id=running-thepipeline>Running the Pipeline<a hidden class=anchor aria-hidden=true href=#running-thepipeline>#</a></h3>
<p>Let’t now take a look at running the pipeline, first let’s check in some code which adds a basic Resource Group.</p>
<p>The Terraform code for this looks like the following;</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurecaf_name&#34; &#34;rg_example&#34;</span> {
  name          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;demogroup&#34;</span>
  resource_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;azurerm_resource_group&#34;</span>
  prefixes      <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;dev&#34;</span>]
  clean_input   <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
}
<span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_resource_group&#34; &#34;resource_group&#34;</span> {
  name     <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurecaf_name</span>.<span style=color:#66d9ef>rg_example</span>.<span style=color:#66d9ef>result</span>
  location <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;uksouth&#34;</span>
  tags     <span style=color:#f92672>=</span> merge(var.default_tags, tomap({ &#34;type&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;resource&#34;</span> }))
}
</code></pre></div><p>I am using the <a href=https://registry.terraform.io/providers/aztfmod/azurecaf/latest/docs/resources/azurecaf_name>Azure CAF Name provider</a> to generate the name of the resource group and then the <a href=https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs>AzureRM provider</a> to create it.</p>
<h4 id=initial-run>Initial Run<a hidden class=anchor aria-hidden=true href=#initial-run>#</a></h4>
<p>As you can from the screen below, there was a single error, which stated that the storage account for the Terraform state file did not exist, buts that OK as that will be created for us.</p>
<p><img loading=lazy src=images/tf01.png alt>
</p>
<p>The two screens below show the warnings;</p>
<div class=gallery>
<div><img loading=lazy src=images/tf02.png></div><div><img loading=lazy src=images/tf03.png></div>
</div><br>
<h4 id=no-changesrun>No ChangesRun<a hidden class=anchor aria-hidden=true href=#no-changesrun>#</a></h4>
<p>The next run didn’t add, change or remove any resources which meant that neither the <code>HAS_CHANGES_ONLY</code> or <code>HAS_DESTROY_CHANGES</code> variables were set to <code>true</code>, so the <code>terraform apply</code> stages did not run this time;</p>
<p><img loading=lazy src=images/tf04.png alt>
</p>
<h4 id=introducing-somemistakes>Introducing some mistakes<a hidden class=anchor aria-hidden=true href=#introducing-somemistakes>#</a></h4>
<p>One thing which hasn’t happened yet is that we have not added anything which Checkov would scan, let’s do that now by adding a Network Security Group to our Terraform file;</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurecaf_name&#34; &#34;nsg&#34;</span> {
  name          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;demo&#34;</span>
  resource_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;azurerm_network_security_group&#34;</span>
  prefixes      <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;dev&#34;</span>]
  clean_input   <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
}

<span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurecaf_name&#34; &#34;ssh&#34;</span> {
  name          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ssh&#34;</span>
  resource_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;azurerm_network_security_rule&#34;</span>
  prefixes      <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;dev&#34;</span>]
  clean_input   <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
}

<span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurecaf_name&#34; &#34;rdp&#34;</span> {
  name          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;rdp&#34;</span>
  resource_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;azurerm_network_security_rule&#34;</span>
  prefixes      <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;dev&#34;</span>]
  clean_input   <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
}

<span style=color:#66d9ef>resource</span> <span style=color:#66d9ef>azurerm_network_security_group</span> <span style=color:#e6db74>&#34;nsg&#34;</span> {
  name                <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurecaf_name</span>.<span style=color:#66d9ef>nsg</span>.<span style=color:#66d9ef>result</span>
  resource_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>resource_group</span>.<span style=color:#66d9ef>name</span>
  location            <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>resource_group</span>.<span style=color:#66d9ef>location</span>

  <span style=color:#66d9ef>security_rule</span> {
    access                     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Allow&#34;</span>
    direction                  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Inbound&#34;</span>
    name                       <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurecaf_name</span>.<span style=color:#66d9ef>ssh</span>.<span style=color:#66d9ef>result</span>
    priority                   <span style=color:#f92672>=</span> <span style=color:#ae81ff>200</span>
    protocol                   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TCP&#34;</span>
    source_address_prefix      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*&#34;</span>
    source_port_range          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*&#34;</span>
    destination_port_range     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;22-22&#34;</span>
    destination_address_prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*&#34;</span>
  }

  <span style=color:#66d9ef>security_rule</span> {
    access                     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Allow&#34;</span>
    direction                  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Inbound&#34;</span>
    name                       <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurecaf_name</span>.<span style=color:#66d9ef>rdp</span>.<span style=color:#66d9ef>result</span>
    priority                   <span style=color:#f92672>=</span> <span style=color:#ae81ff>300</span>
    protocol                   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TCP&#34;</span>
    source_address_prefix      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*&#34;</span>
    source_port_range          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*&#34;</span>
    destination_port_range     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;3389-3389&#34;</span>
    destination_address_prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*&#34;</span>
  }
}
</code></pre></div><p>Nothing to bad on the face of it you maybe thinking, let’s commit the change which will trigger a run of the pipeline;</p>
<p><img loading=lazy src=images/tf05.png alt>
</p>
<p>Whoops, the Checkov stage failed, clicking on <strong>Tests</strong> should give us more information as to why;</p>
<p><img loading=lazy src=images/tf06.png alt>
</p>
<p>Clicking on either the two results will give a more information;</p>
<div class=gallery>
<div><img loading=lazy src=images/tf07.png></div><div><img loading=lazy src=images/tf08.png></div>
</div><br>
<p>As you can see, we are allow full access to both SSH and RDP to the whole internet — not a great idea so we will need to update the code to lock those two rules down to an IP address. Thankfully, the Checkov stage errored before any of the Terraform stages were executed meaning that our mistake never made it as far as being deployed.</p>
<p>A quick code change & commit later and we have the tests passing and the changes being automatically deployed — which is expected as there is only the addition of the network security group;</p>
<div class=gallery>
<div><img loading=lazy src=images/tf09.png></div><div><img loading=lazy src=images/tf10.png></div>
</div><br>
<p>Let’s now look at removing the network security group we just added.</p>
<h4 id=manual-approval>Manual Approval<a hidden class=anchor aria-hidden=true href=#manual-approval>#</a></h4>
<p>Commenting out the network security group configuration in the Terraform code and committing it should be enough to trigger a run which will resource in resources being removed.</p>
<p>This will result in an e-mail;</p>
<p><img loading=lazy src=images/tf11.png alt>
</p>
<p>Going to the pipeline, clicking on <strong>Review</strong>, entering a comment then pressing the <strong>Resume</strong> button will then trigger the <code>terraform apply</code> stage;</p>
<div class=gallery>
<div><img loading=lazy src=images/tf12.png></div><div><img loading=lazy src=images/tf13.png></div><div><img loading=lazy src=images/tf14.png></div>
</div><br>
<p>Once complete the network security group will have been destroyed, which is what we expected to happen, however, sometimes something unexpected may have happened and resources which you thought were not being touched by your changes maybe being destroyed so that they can be redeployed to make a change which isn’t possible any other way, this is where having your pipeline prompt you that it is going to remove resources comes in extremely useful 😊</p>
<h3 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>#</a></h3>
<p>As I find myself collaborating on more and more complex Terraform deployments it can get a little scary for all involved if you have a pipeline triggering automatically when you commit.</p>
<p>This means having checks in place which not only make sure that simple mistakes, like opening up management ports to the internet, but also to check that the code is valid before it gets executed is a good safety net.</p>
<p>An even bigger safety net is triggering the <code>terraform apply</code> command based on the results of a <code>terraform plan</code> so that checks can be made to ensure that nothing bad or unexpected is going to happen as a result of the changes you are applying —after all, stoping an outage before it becomes an outage is always the best option 👍</p>
<p>You can find the full pipeline along with the Terraform code at <a href=https://github.com/russmckendrick/DevOpsTerraformPipeline>https://github.com/russmckendrick/DevOpsTerraformPipeline</a>.</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://www.mediaglasses.blog/tags/terraform/>Terraform</a></li>
<li><a href=https://www.mediaglasses.blog/tags/azure-devops/>Azure Devops</a></li>
<li><a href=https://www.mediaglasses.blog/tags/azure/>Azure</a></li>
<li><a href=https://www.mediaglasses.blog/tags/checkov/>Checkov</a></li>
<li><a href=https://www.mediaglasses.blog/tags/pipeline/>Pipeline</a></li>
</ul>
<nav class=paginav>
<a class=next href=https://www.mediaglasses.blog/2021/04/25/azure-devops-multi-stage-pipelines/>
<span class=title>Next Page »</span>
<br>
<span>Azure DevOps Multi-Stage Pipelines</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share Azure DevOps Terraform Pipeline  with Checkov & Approvals on twitter" href="https://twitter.com/intent/tweet/?text=Azure%20DevOps%20Terraform%20Pipeline%20%20with%20Checkov%20%26%20Approvals&url=https%3a%2f%2fwww.mediaglasses.blog%2f2021%2f06%2f08%2fazure-devops-terraform-pipeline-with-checkov-approvals%2f&hashtags=Terraform%2cAzureDevops%2cAzure%2cCheckov%2cPipeline"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Azure DevOps Terraform Pipeline  with Checkov & Approvals on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.mediaglasses.blog%2f2021%2f06%2f08%2fazure-devops-terraform-pipeline-with-checkov-approvals%2f&title=Azure%20DevOps%20Terraform%20Pipeline%20%20with%20Checkov%20%26%20Approvals&summary=Azure%20DevOps%20Terraform%20Pipeline%20%20with%20Checkov%20%26%20Approvals&source=https%3a%2f%2fwww.mediaglasses.blog%2f2021%2f06%2f08%2fazure-devops-terraform-pipeline-with-checkov-approvals%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Azure DevOps Terraform Pipeline  with Checkov & Approvals on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.mediaglasses.blog%2f2021%2f06%2f08%2fazure-devops-terraform-pipeline-with-checkov-approvals%2f&title=Azure%20DevOps%20Terraform%20Pipeline%20%20with%20Checkov%20%26%20Approvals"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Azure DevOps Terraform Pipeline  with Checkov & Approvals on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.mediaglasses.blog%2f2021%2f06%2f08%2fazure-devops-terraform-pipeline-with-checkov-approvals%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Azure DevOps Terraform Pipeline  with Checkov & Approvals on whatsapp" href="https://api.whatsapp.com/send?text=Azure%20DevOps%20Terraform%20Pipeline%20%20with%20Checkov%20%26%20Approvals%20-%20https%3a%2f%2fwww.mediaglasses.blog%2f2021%2f06%2f08%2fazure-devops-terraform-pipeline-with-checkov-approvals%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Azure DevOps Terraform Pipeline  with Checkov & Approvals on telegram" href="https://telegram.me/share/url?text=Azure%20DevOps%20Terraform%20Pipeline%20%20with%20Checkov%20%26%20Approvals&url=https%3a%2f%2fwww.mediaglasses.blog%2f2021%2f06%2f08%2fazure-devops-terraform-pipeline-with-checkov-approvals%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://www.mediaglasses.blog/>MediaGlasses</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)">
<button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</button>
</a><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>const images=Array.from(document.querySelectorAll(".post-content img"));images.forEach(a=>{mediumZoom(a,{margin:0,scrollOffset:40,container:null,template:null})})</script>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>